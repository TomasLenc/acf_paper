---
title: "Comparison of lag selections"
author: "Tomas Lenc"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: 
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source('config.R')
source('figures.R')
source('utils.R')

```



<br><br><br><br><br>

---

# Full trial vs. chunk-avg

<br><br>

## Sensitivity to noise

Let's re-run the simualtion from the main report, where we took a known ground-truth signal and 
tried to estimate the acf values at lags of interest after different amounts of noise are added 
to the signal.  

We're interested to see whether we can gain any SNR by chunking and averaging the long trials before
estimating the ACF function.  

```{r, fig.height=6, fig.width=10}

data_path = file.path(experiment_path, 'data',
                      'maxlag-4.8_meterRel-0.8_meterUnrel-0.6_1.0_1.4_ignore-0.4')

fname <- 'irType-square_apFitMethod-irasa_onlyHarm-true_noiseEffectDistErpVsTrial.csv'

df <- read.csv(file.path(data_path, fname))

```

```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

Here is the selection of lags we're going to use: 

**Meter-related lags**: `r round(par_matlab$lags_meter_rel, 2)` s. 

**Meter-unrelated lags**: `r round(par_matlab$lags_meter_unrel, 2)` s.  

<br>  

For chunking, we will take `r par_matlab$erp_chunk_dur` s.  


```{r}

m_trial <- fit_sigm(log10(df$z_snr_trial), df$r_trial_subtr, 
                    init_params=list('min_'=0, 'max_'=1, 'x50_'=1.4, 'slope_'=2)
                    )

m_erp <- fit_sigm(log10(df$z_snr_trial), df$r_erp_subtr, 
                    init_params=list('min_'=0, 'max_'=1, 'x50_'=1.4, 'slope_'=2)
                    )

cols <- c('trial'='#4287f5', 
          'erp'='#db8c37')

ggplot() +
    geom_point(data=df, aes(log10(z_snr_trial), r_erp_subtr), 
               color=lighten(cols['erp'], 0.2), alpha=0.2) +
    geom_point(data=df, aes(log10(z_snr_trial), r_trial_subtr), 
               color=lighten(cols['trial'], 0.2), alpha=0.2) + 
    geom_function(fun=sigm, args=coef(m_trial), aes(color='trial'), linewidth=2) +
    geom_function(fun=sigm, args=coef(m_erp), aes(color='erp'), linewidth=2) +
    geom_hline(yintercept = 0, color='#000000') + 
    scale_color_manual(name='segment type', values=cols) + 
    scale_y_continuous(limits=c(-1, 1), breaks=c(-1, 0, 1)) + 
    ylab('r with ground truth') + 
    theme_cowplot() +
    scale_x_reverse()     
    

```

<br> 

Below is the same data but shown as density estimates at multiple slices through the log z_snr values.  

```{r, fig.height=6, fig.width=12}

p1 <- plot_dist_to_truth_density(df, 
                                y_var_name='r_trial_subtr',
                                z_snr_var_name='z_snr_trial')

p2 <- plot_dist_to_truth_density(df, 
                                y_var_name='r_erp_subtr',
                                z_snr_var_name='z_snr_trial')

plot_grid(p1, p2, nrow=2)

```







<br><br><br><br><br>

---

## Lowhigh EEG

Let's compare the ACF estimate done on the original, trial-length data, and on chunked averaged 
erp data. The question is whether time-domain averaging of successive chunks may increase SNR. 

```{r}

rhythms <- c('unsyncopated', 'syncopated')
tones <- c('L', 'H')

cols <- c(L='#b52c0d', H='#1058b0')
cols_individual <- lighten(cols, amount=0.7)
names(cols_individual) <- names(cols)


```

Let's start by taking the selection of lags up to 4.8 s.  

```{r}
data_path = file.path(experiment_path, 'data',
                      'maxlag-4.8_meterRel-0.8_meterUnrel-0.6_1.0_1.4_ignore-0.4')

fname <- 'exp-lowhigh_apFitMethod-irasa_onlyHarm-true_roi-frontocentral_eegIndividual.csv'


df_trial <- read.csv(file.path(data_path, fname))
df_trial$rhythm <- factor(df_trial$rhythm,  levels=rhythms)
df_trial$tone <- factor(df_trial$tone,  levels=tones)
```


```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

Here is the selection: 

**Meter-related lags**: `r round(par_matlab$lags_meter_rel, 2)` s. 

**Meter-unrelated lags**: `r round(par_matlab$lags_meter_unrel, 2)` s.  

<br>  

And here we're plotting the results for full-trial data.  

```{r, fig.align="center"}
fname_acf_plot <- file.path(data_path, paste0(tools::file_path_sans_ext(fname), '_acf.svg'))
knitr::include_graphics(fname_acf_plot)
```

<br>  

```{r}
p <- plot_feat_ind_lowhigh(df_trial, 
              col_name_eeg='z_meter_acf_subtr',
              col_name_coch='z_meter_acf_sound')

p
```


<br>  

```{r}
fname <- 'exp-lowhigh_apFitMethod-irasa_onlyHarm-true_roi-frontocentral_chunk-9.6s_eegIndividual.csv'

df_erp <- read.csv(file.path(data_path, fname))
df_erp$rhythm <- factor(df_erp$rhythm,  levels=rhythms)
df_erp$tone <- factor(df_erp$tone,  levels=tones)
```

```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

And here we're plotting the results for chunk-erp-averaged data (chunk duration: `r par_matlab$chunk_dur` s).  


```{r, fig.align="center"}
fname_acf_plot <- file.path(data_path, paste0(tools::file_path_sans_ext(fname), '_acf.svg'))
knitr::include_graphics(fname_acf_plot)
```

<br>  

```{r}
p <- plot_feat_ind_lowhigh(df_erp, 
              col_name_eeg='z_meter_acf_subtr',
              col_name_coch='z_meter_acf_sound')

p
```



How does this compare to taking the same selection of lags all the way up to half trial duration?    

```{r}
data_path = file.path(experiment_path, 'data',
                      'maxlag-halfTrial_meterRel-0.8_meterUnrel-0.6_1.0_1.4_ignore-0.4')

fname <- 'exp-lowhigh_apFitMethod-irasa_onlyHarm-true_roi-frontocentral_eegIndividual.csv'

df_trial <- read.csv(file.path(data_path, fname))
df_trial$rhythm <- factor(df_trial$rhythm,  levels=rhythms)
df_trial$tone <- factor(df_trial$tone,  levels=tones)
```

```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

Here is the selection: 

**Meter-related lags**: `r round(par_matlab$lags_meter_rel, 2)` s. 

**Meter-unrelated lags**: `r round(par_matlab$lags_meter_unrel, 2)` s.  

<br>  

```{r, fig.align="center"}
fname_acf_plot <- file.path(data_path, paste0(tools::file_path_sans_ext(fname), '_acf.svg'))
knitr::include_graphics(fname_acf_plot)
```

<br>  

```{r}
p <- plot_feat_ind_lowhigh(df_trial, 
              col_name_eeg='z_meter_acf_subtr',
              col_name_coch='z_meter_acf_sound')

p
```














<br><br><br><br><br>

---

# FFT vs. ACF


<br><br>


## Sensitivity to noise

The correlation between estimated amplitudes/acf values with ground truth values may depend on the 
number of frequencies/lags of interest.   

Perhaps this may "disadvantage" the FFT in some way? Let's try the same but fixing the 
number of frequencies and lags of interest to 11. That is, we take the first 11 frequencies or lags
of interest and re-do the correlation analysis under different amounts of noise.  

```{r}
data_path = file.path(experiment_path, 'data',
                      'maxlag-halfTrial_meterRel-0.8_meterUnrel-0.6_1.0_1.4_ignore-0.4')

fname <- 'irType-square_apFitMethod-irasa_onlyHarm-true_noiseEffectDistACFvsFFT.csv'

df <- read.csv(file.path(data_path, fname))
```

```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

Here is the selection of frequencies:  

**Meter-related freq**: `r round(par_matlab$freq_meter_rel, 2)` s. 

**Meter-unrelated freq**: `r round(par_matlab$freq_meter_unrel, 2)` s.  



<br><br><br>  

And here are the lags of interest up to half-trial duration.  

**Meter-related lags**: `r round(par_matlab$lags_meter_rel, 2)` s. 

**Meter-unrelated lags**: `r round(par_matlab$lags_meter_unrel, 2)` s.  


<br>  

```{r}
p <- plot_dist_to_truth(df)
p
```

<br><br>

And here is the control selection, restricting the number of lags to first 11.   

```{r}
data_path <- str_replace(data_path, '(?<=maxlag-)[a-zA-Z]+', '11lags')

fname <- 'irType-square_apFitMethod-irasa_onlyHarm-true_noiseEffectDistACFvsFFT.csv'

df <- read.csv(file.path(data_path, fname))
```

```{r}
fname_par <- paste0(tools::file_path_sans_ext(fname), '_par.mat')
par_matlab <- drop(R.matlab::readMat(file.path(data_path, fname_par), fixNames=FALSE)$par)
```

**Meter-related lags**: `r round(par_matlab$lags_meter_rel, 2)` s. 

**Meter-unrelated lags**: `r round(par_matlab$lags_meter_unrel, 2)` s.  

<br>  

```{r}
p <- plot_dist_to_truth(df, 
                   init_params_acf=list('min_'=0, 'max_'=1, 'x50_'=0.4, 'slope_'=1.2))
p

```










