---
title: "Autocorrelation Attention"
author: "Tomas Lenc"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: 
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source('config.R')
source('figures.R')
source('utils.R')

```


```{r}

rhythms <- c('unsyncopated', 'syncopated')
tasks <- c('tempo', 'pitch', 'arithmetics')

data_path = file.path(experiment_path, 'data')

df_eeg_ind_fft <- read.csv(file.path(data_path, 
                                  sprintf('exp-attention_apFitMethod-%s_roi-%s_eegIndividual_fft.csv', 
                                          ap_fit_method, roi_name)))
df_eeg_ind_acf <- read.csv(file.path(data_path, 
                                  sprintf('exp-attention_apFitMethod-%s_roi-%s_eegIndividual_acf.csv', 
                                          ap_fit_method, roi_name)))

df_eeg_ind <- merge(df_eeg_ind_fft, df_eeg_ind_acf, by=c('subject', 'rhythm', 'task'))

df_eeg_boot <- read.csv(file.path(data_path, 
                                  sprintf('exp-attention_apFitMethod-%s_roi-%s_eegBoot.csv', 
                                          ap_fit_method, roi_name)))
df_eeg_grand <- read.csv(file.path(data_path, 
                                  sprintf('exp-attention_apFitMethod-%s_roi-%s_eegGrand.csv', 
                                          ap_fit_method, roi_name)))

# remove subjects
df_eeg_ind <- filter(df_eeg_ind, subject >= 5)

df_eeg_ind$subject <- factor(df_eeg_ind$subject)
df_eeg_ind$rhythm <- factor(df_eeg_ind$rhythm,  levels=rhythms)
df_eeg_ind$task <- factor(df_eeg_ind$task,  levels=tasks)

df_eeg_boot$rhythm <- factor(df_eeg_boot$rhythm,  levels=rhythms)
df_eeg_boot$task <- factor(df_eeg_boot$task,  levels=tasks)

df_eeg_grand$rhythm <- factor(df_eeg_grand$rhythm,  levels=rhythms)
df_eeg_grand$task <- factor(df_eeg_grand$task,  levels=tasks)

# load matlab parameters
library(R.matlab)
par_matlab <- drop(readMat(file.path(data_path,
                                  sprintf('exp-attention_apFitMethod-%s_roi-%s_eegBoot_par.mat',
                                          ap_fit_method, roi_name)), fixNames=FALSE)$par)


cols <- c(tempo='red', pitch='blue', arithmetics='purple')
cols_individual <- lighten(cols, amount=0.7)
names(cols_individual) <- names(cols)
```


```{r}

# df <- df_eeg_ind
# col_name_eeg='z_meter_acf_subtr'
# col_name_coch='z_meter_acf_sound'

plot_feat_ind <- function(df, 
                         col_name_eeg='z_meter_fft_subtr', col_name_coch='z_meter_fft_sound'){
    
    df$x <- as.numeric(df$task)
    df$x_coch_start <- df$x-0.3
    df$x_coch_end <- df$x+0.3
    
    df_summary <- summarySE(df, groupvars=c('rhythm', 'task'), measurevar=col_name_eeg)
    
    df_summary$x <- as.numeric(df_summary$task)
    
    p <- ggplot(df, aes(x, .data[[col_name_eeg]], color=task)) + 
        geom_segment(data=df[df$subject==df$subject[1],],
                     inherit.aes=FALSE,
                     aes(x=x_coch_start, xend=x_coch_end,
                         y=.data[[col_name_coch]], yend=.data[[col_name_coch]],
                         color=task),
                     linewidth=3, alpha=0.5) +
        scale_color_manual(name='task', values=cols) +
        scale_x_continuous(breaks=c(1:length(levels(df$task))), 
                           labels=levels(df$task)) +  
        new_scale_color() + new_scale_fill() +
        geom_point(aes(color=task), size=2, position=position_jitter(width=0.1, height=0)) +
        scale_color_manual(name='task', values=cols_individual) + 
        geom_hline(yintercept=0) +
        new_scale_color() + new_scale_fill() + 
        geom_point(data=df_summary, aes(color=task), size=3) + 
        geom_errorbar(data=df_summary, 
                      aes(color=task, ymin=.data[[col_name_eeg]]-ci,
                          ymax=.data[[col_name_eeg]]+ci), 
                      linewidth=1, width=0.2) + 
        scale_color_manual(name='task', values=cols) + 
        facet_wrap(~rhythm, nrow=1) + 
        theme_cowplot() + 
        my_theme()
    
    return(p)
}


# df <- df_eeg_grand
# df_boot <- df_eeg_boot
# col_name_eeg='z_meter_fft_subtr'
# col_name_coch='z_meter_fft_sound'

plot_feat_boot <- function(df, df_boot, 
                           col_name_eeg='z_meter_fft_subtr', col_name_coch='z_meter_fft_sound'){

    df$x <- as.numeric(df$task)
    df$x_coch_start <- df$x-0.4
    df$x_coch_end <- df$x+0.4
    
    df_boot$x <- as.numeric(df_boot$task)
    
    df_ci <- df_boot %>% 
        group_by(task, rhythm) %>% 
        group_modify(~ get_boot_summary(.x, .y, feature_name=col_name_eeg)) 
        
    df_summary <- join(df_ci, 
                       df %>% select(task, rhythm, x, 
                                     x_coch_start, x_coch_end, 
                                     .data[[col_name_eeg]], .data[[col_name_coch]]), 
                       by=c('task', 'rhythm'))
    
    p <- ggplot(df_summary, aes(x, .data[[col_name_eeg]], color=task)) + 
        geom_segment(aes(x=x_coch_start, xend=x_coch_end,
                         y=.data[[col_name_coch]], yend=.data[[col_name_coch]],
                         color=task),
                     linewidth=3, alpha=0.5) +
        scale_color_manual(name='task', values=cols)+
        scale_fill_manual(name='task', values=cols) +
        scale_x_continuous(breaks=c(1:length(levels(df$task))), 
                           labels=levels(df$task)) +  
        geom_half_violin(data=df_boot, aes(fill=task, group=task), 
                         side='l', scale='width', fill='grey60', color=NA, alpha=0.6, trim=T) + 
        geom_hline(yintercept=0) +
        geom_point(aes(x=x+0.15, color=task), size=3) + 
        geom_errorbar(aes(x=x+0.15, color=task, ymin=ci_low, ymax=ci_high), 
                      linewidth=1, width=0) + 
        facet_wrap(~rhythm, nrow=1) + 
        theme_cowplot() + 
        my_theme()
    
    return(p)
}

```


Reference channels:  
`r unlist(par_matlab$ref_chans)`  

ROI channels (averaged in the time domain):  
`r unlist(par_matlab$roi_chans)`  

<br>

--- 

<br>

## EEG individual 

<br> 

### FFT

Frequencies of interest were selected as follows:   

**Meter-related**: `r round(par_matlab$freq_meter_rel, 2)` Hz. 

**Meter-unrelated**: `r round(par_matlab$freq_meter_unrel, 2)` Hz. 


```{r}
plot_feat_ind(df_eeg_ind, 
              col_name_eeg='z_meter_fft_subtr',
              col_name_coch='z_meter_fft_sound')
```
<br> 

Mixed model (factors: rhythm x task)

```{r}
m <- lmer(z_meter_fft_subtr ~ rhythm * task + (1|subject), data=df_eeg_ind)
pander(Anova(m))
```
<br> 

Posthoc tests task: 

```{r}
m_posthoc <- lmer(z_meter_fft_subtr ~ rhythm + task + (1|subject), data=df_eeg_ind)
emm <- emmeans(m_posthoc, 'task')
c <- contrast(emm, 'pairwise', adjust='bonferroni')
pander(as.data.frame(c))
```
<br> 

T-test against 0 (fdr corrected): 
```{r}

ttest_0 <- function(df, var_name){
    vals_eeg <- df %>% pull(.data[[var_name]])
    res <- t.test(vals_eeg, mu=0, alternative='greater')
    data.frame(t=res$statistic, p=res$p.value)
}

df_posthoc <- df_eeg_ind %>% 
    group_by(rhythm, task) %>% 
    group_modify(~ttest_0(.x, var_name='z_meter_fft_subtr'))

df_posthoc$p <- p.adjust(df_posthoc$p, method='fdr')

pander(df_posthoc)
```



<br><br><br> 

### ACF

Individual participant data. 1/f component was estimated using **`r ap_fit_method`** method, separately for each participant. 

Lags of interest were seleted as follows:   

**Meter-related**: `r par_matlab$lags_meter_rel` s. 

**Meter-unrelated**: `r par_matlab$lags_meter_unrel` s. 


```{r}
plot_feat_ind(df_eeg_ind, 
              col_name_eeg='z_meter_acf_subtr',
              col_name_coch='z_meter_acf_sound')
```
<br> 

Mixed model (factors: rhythm x task)

```{r}
m <- lmer(z_meter_acf_subtr ~ rhythm * task + (1|subject), data=df_eeg_ind)
pander(Anova(m))
```
<br> 

T-test against cochlear model (fdr corrected): 
```{r}

ttest_sound <- function(df, var_name_eeg, var_name_sound){
    vals_eeg <- df %>% pull(.data[[var_name_eeg]])
    val_sound <- unique(df %>% pull(.data[[var_name_sound]]))
    res <- t.test(vals_eeg, mu=val_sound, alternative='greater')
    data.frame(t=res$statistic, p=res$p.value)
}

df_posthoc <- df_eeg_ind %>% 
    group_by(rhythm, task) %>% 
    group_modify(~ttest_sound(.x, 
                      var_name_eeg='z_meter_acf_subtr', 
                      var_name_sound='z_meter_acf_sound'))

df_posthoc$p <- p.adjust(df_posthoc$p, method='fdr')

pander(df_posthoc)
```




<br>

## EEG boot 

We computed `r par_matlab$n_boot` bootstrap samples, separately for each condition.  


<br> 

### FFT


```{r}
plot_feat_boot(df_eeg_grand, df_eeg_boot,  
              col_name_eeg='z_meter_fft_subtr',
              col_name_coch='z_meter_fft_sound')
```

<br> 

### ACF

```{r}
plot_feat_boot(df_eeg_grand, df_eeg_boot,  
              col_name_eeg='z_meter_acf_subtr',
              col_name_coch='z_meter_acf_sound')
```
<br> 

Proportion test against cochlear/0 (fdr corrected): 

```{r}

prop_test_sound <- function(df, var_name_eeg, var_name_sound){
    vals_eeg <- df %>% pull(.data[[var_name_eeg]])
    val_sound <- unique(df %>% pull(.data[[var_name_sound]]))
    p <- mean(vals_eeg < val_sound)
    data.frame(p=p)
}

prop_test_0 <- function(df, var_name_eeg){
    vals_eeg <- df %>% pull(.data[[var_name_eeg]])
    p <- mean(vals_eeg < 0)
    data.frame(p=p)
}

# df_posthoc <- df_eeg_boot %>% 
#     group_by(rhythm, task) %>% 
#     group_modify(~prop_test_sound(.x, 
#                       var_name_eeg='z_meter_acf_subtr', 
#                       var_name_sound='z_meter_acf_sound'))

df_posthoc <- df_eeg_boot %>%
    group_by(rhythm, task) %>%
    group_modify(~prop_test_0(.x, var_name='z_meter_acf_subtr'))


df_posthoc$p <- p.adjust(df_posthoc$p, method='fdr')

pander(df_posthoc)

```











